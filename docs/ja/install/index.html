<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="PG-Strom Development Team" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>インストール - PG-Strom Manual</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="//fonts.googleapis.com/earlyaccess/notosansjp.css" rel="stylesheet" />
        <link href="//fonts.googleapis.com/css?family=Open+Sans:600,800" rel="stylesheet" />
        <link href="../custom.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb";
        var mkdocs_page_input_path = "install.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> PG-Strom Manual
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
  [<strong>Japanese</strong> | <a href="../../install/"    style="color: #cccccc">English</a>]
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">はじめに</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">インストール</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#_2">チェックリスト</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_3">インストール手順</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#os">OSのインストール</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#nouveau">nouveauドライバの無効化</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#iommu">IOMMUの無効化</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#rhel9">RHEL9における設定</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#rhel8">RHEL8における設定</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_4">追加リポジトリの有効化</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#epelextra-packages-for-enterprise-linux">EPEL(Extra Packages for Enterprise Linux)</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#red-hat-codeready-linux-builder">Red Hat CodeReady Linux Builder</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mofed">MOFEDドライバのインストール</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#heterodb-swdc">heterodb-swdcのインストール</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#cuda-toolkit">CUDA Toolkitのインストール</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#gpudirect-storage">GPUDirect Storageの確認</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#pci-bar1">PCI Bar1メモリの設定</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#heterodb">HeteroDB 拡張モジュール</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_5">ライセンスの有効化</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#postgresql">PostgreSQLのインストール</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#libarrowlibparquet">libarrow/libparquetのインストール</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#pg-strom">PG-Stromのインストール</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#rpm">RPMによるインストール</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_6">ソースからのインストール</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#_7">ソースコードの入手</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#pg-strom_1">PG-Stromのビルド</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_8">インストール後の設定</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_9">データベースクラスタの作成</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#postgresqlconf">postgresql.confの編集</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#os_1">OSのリソース制限の拡張</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#postgresql_1">PostgreSQLの起動</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#pg-strom_2">PG-Stromエクステンションの作成</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#postgis">PostGISのインストール</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#ubuntu-linux">Ubuntu Linuxへのインストール</a>
    </li>
    </ul>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">利用ガイド</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../operations/">基本的な操作</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../brin/">BRINインデックス</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../partition/">パーティション</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../postgis/">GPU版PostGIS</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../gpusort/">GPUソート</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../troubles/">トラブルシューティング</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">先進機能</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../ssd2gpu/">GPUダイレクトSQL</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../arrow_fdw/">Apache Arrow</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../gpucache/">GPUキャッシュ</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../pinned_buffer/">Pinned Inner Buffer</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../fluentd/">Fluentd連携</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">リファレンス</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../ref_types/">データ型</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ref_devfuncs/">関数と演算子</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ref_sqlfuncs/">SQLオブジェクト</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ref_params/">GUCパラメータ</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">リリースノート</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../release_v6.0/">PG-Strom v6.0</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../release_v5.2/">PG-Strom v5.2</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../release_v5.1/">PG-Strom v5.1</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../release_v5.0/">PG-Strom v5.0</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../release_v3.0/">PG-Strom v3.0</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../release_v2.3/">PG-Strom v2.3</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../release_v2.2/">PG-Strom v2.2</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../release_v2.0/">PG-Strom v2.0</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">PG-Strom Manual</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">インストール</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="_1">インストール</h1>
<p>本章ではPG-Stromのインストール手順について説明します。</p>
<h2 id="_2">チェックリスト</h2>
<ul>
<li><strong>ハードウェア</strong><ul>
<li>CUDA ToolkitのサポートするLinuxオペレーティングシステムを動作可能な x86_64 アーキテクチャのハードウェアが必要です。 </li>
<li>CPU、ストレージ、およびネットワークデバイスには特別な要件はありませんが、<a href="https://github.com/heterodb/pg-strom/wiki/002:-HW-Validation-List">note002:HW Validation List</a>はハードウェア選定の上で参考になるかもしれません。</li>
<li>GPUダイレクトSQL実行を利用するにはNVME規格に対応したSSD、またはRoCEに対応した高速NICが必要で、GPUと同一のPCIe Root Complex配下に接続されている必要があります。</li>
</ul>
</li>
<li><strong>GPUデバイス</strong><ul>
<li>PG-Stromを実行するには少なくとも一個のGPUデバイスがシステム上に必要です。これらはCUDA Toolkitでサポートされており、computing capability が6.0以降のモデル（Pascal世代以降）である必要があります。</li>
<li><a href="https://github.com/heterodb/pg-strom/wiki/002:-HW-Validation-List#list-of-supported-gpu-models">002: HW Validation List - List of supported GPU models</a>を参考にGPUを選定してください。</li>
</ul>
</li>
<li><strong>Operating System</strong><ul>
<li>PG-Stromの実行には、CUDA Toolkitによりサポートされているx86_64アーキテクチャ向けのLinux OSが必要です。推奨環境はRed Hat Enterprise LinuxまたはRocky Linuxバージョン 9.x、または8.xです。</li>
<li>GPUダイレクトSQL（cuFileドライバ）を利用するには、CUDA Toolkitに含まれるnvidia-fsドライバと、Mellanox OFED (OpenFabrics Enterprise Distribution) ドライバのインストールが必要です。</li>
</ul>
</li>
<li><strong>PostgreSQL</strong><ul>
<li>PG-Strom v5.0の実行にはPostgreSQLバージョン15以降が必要です。</li>
<li>PG-Stromが内部的に利用しているAPIの中には、これ以前のバージョンでは提供されていないものが含まれています。</li>
</ul>
</li>
<li><strong>CUDA Toolkit</strong><ul>
<li>PG-Stromの実行にはCUDA Toolkit バージョン12.2update1以降が必要です。</li>
<li>PG-Stromが内部的に利用しているAPIの中には、これ以前のバージョンでは提供されていないものが含まれています。</li>
</ul>
</li>
</ul>
<h2 id="_3">インストール手順</h2>
<p>一連のインストール手順は以下の通りとなります。</p>
<ol>
<li>H/Wの初期設定</li>
<li>OSのインストール</li>
<li>MOFEDドライバのインストール</li>
<li>CUDA Toolkit のインストール</li>
<li>HeteroDB拡張モジュールのインストール</li>
<li>PostgreSQLのインストール</li>
<li>PG-Stromのインストール</li>
<li>PostgreSQL拡張モジュールのインストール（必要に応じて）<ul>
<li>PostGIS</li>
<li>contrib/cube</li>
</ul>
</li>
</ol>
<h2 id="os">OSのインストール</h2>
<p>CUDA ToolkitのサポートするLinuxディストリビューションを選択し、個々のディストリビューションのインストールプロセスに従ってインストール作業を行ってください。 CUDA ToolkitのサポートするLinuxディストリビューションは、<a href="https://developer.nvidia.com/">NVIDIA DEVELOPER ZONE</a>において紹介されています。</p>
<p>Red Hat Enterprise Linux 8.x系列（Rocky Linux 8.x系列を含む）の場合、ソフトウェア構成は、ベース環境として「最小限のインストール」を選択し、さらに追加のソフトウェアとして「開発ツール」を選択してください。</p>
<p>Red Hat Enterprise Linux 9.x系列（Rocky Linux 9.x系列を含む）の場合、ソフトウェア構成は、ベース環境として「最小限のインストール」を選択し、さらに追加のソフトウェアとして「標準」「開発ツール」を選択してください。</p>
<p><img alt="RHEL9 Software Selection" src="../img/centos8_package_selection.png" /></p>
<p>サーバーへのOSインストール後、サードパーティーのパッケージをインストールするために、パッケージリポジトリの設定を行います。</p>
<p>なお、インストーラで「開発ツール」を選択しなかった場合、以下のコマンドでOSインストール後に追加インストールする事が可能です。</p>
<pre><code># dnf groupinstall 'Development Tools'
</code></pre>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>サーバに搭載されているGPUが新しすぎる場合、OS起動中にクラッシュ等の問題が発生する場合があります。
その場合、カーネル起動オプションに<code>nouveau.modeset=0</code>を追加して標準のグラフィックスドライバを無効化する事で
問題を回避できるかもしれません。</p>
</div>
<h3 id="nouveau">nouveauドライバの無効化</h3>
<p>NVIDIA製GPU向けオープンソースの互換ドライバであるnouveauドライバがロードされている場合、nvidiaドライバをロードする事ができません。
この場合は、nouveauドライバの無効化設定を行った上でシステムを一度再起動してください。</p>
<p>nouveauドライバを無効化するには、以下の設定を<code>/etc/modprobe.d/disable-nouveau.conf</code>という名前で保存し、<code>dracut</code>コマンドを実行してLinux kernelのブートイメージに反映します。
その後、システムを一度再起動してください。</p>
<pre><code># cat &gt; /etc/modprobe.d/disable-nouveau.conf &lt;&lt;EOF
blacklist nouveau
options nouveau modeset=0
EOF
# dracut -f
# shutdown -r now
</code></pre>
<h3 id="iommu">IOMMUの無効化</h3>
<p>GPU-Direct SQLはCUDAのGPUDirect Storage (cuFile)というAPIを使用しています。</p>
<p>GPUDirect Storageの利用に先立って、OS側でIOMMUの設定を無効化する必要があります。</p>
<p><a href="https://docs.nvidia.com/gpudirect-storage/troubleshooting-guide/index.html#install-prereqs">NVIDIA GPUDirect Storage Installation and Troubleshooting Guide</a>の記述を参考に、カーネル起動オプションの設定を行ってください。</p>
<p>IOMMUを無効化するには、カーネル起動オプションに<code>amd_iommu=off</code> (AMD製CPUの場合)または、<code>intel_iommu=off</code> (Intel製CPUの場合)の設定を付加します。</p>
<h4 id="rhel9">RHEL9における設定</h4>
<p>以下のコマンドを実行し、カーネル起動オプションを追加してください。</p>
<pre><code># grubby --update-kernel=ALL --args=&quot;amd_iommu=off&quot;
</code></pre>
<h4 id="rhel8">RHEL8における設定</h4>
<p>エディタで<code>/etc/default/grub</code>を編集し、<code>GRUB_CMDLINE_LINUX_DEFAULT=</code>行に上記のオプションを付加してください。</p>
<p>例えば、以下のような設定となるはずです。</p>
<pre><code>  :
GRUB_CMDLINE_LINUX=&quot;rhgb quiet amd_iommu=off&quot;
  :
</code></pre>
<p>以下のコマンドを実行し、この設定をカーネル起動オプションに反映します。</p>
<pre><code>-- for BIOS based system
# grub2-mkconfig -o /boot/grub2/grub.cfg
# shutdown -r now

-- for UEFI based system
# grub2-mkconfig -o /boot/efi/EFI/redhat/grub.cfg
# shutdown -r now
</code></pre>
<h3 id="_4">追加リポジトリの有効化</h3>
<h4 id="epelextra-packages-for-enterprise-linux">EPEL(Extra Packages for Enterprise Linux)</h4>
<p>PG-Stromの実行に必要なソフトウェアモジュールのいくつかは、EPEL(Extra Packages for Enterprise Linux)の一部として配布されています。
これらのソフトウェアを入手するためにEPELパッケージ群のリポジトリ定義をyumシステムに追加する必要があります。</p>
<p>EPELリポジトリから入手するパッケージの一つがDKMS(Dynamic Kernel Module Support)です。これは動作中のLinuxカーネルに適合したLinuxカーネルモジュールをオンデマンドでビルドするためのフレームワークで、NVIDIAのGPUデバイスドライバなど関連するカーネルモジュールが使用しています。
Linuxカーネルモジュールは、Linuxカーネルのバージョンアップに追従して再ビルドが必要であるため、DKMSなしでのシステム運用は現実的ではありません。</p>
<p>EPELリポジトリの定義は <code>epel-release</code> パッケージにより提供され、<a href="https://docs.fedoraproject.org/en-US/epel/#_quickstart">Fedora Project</a>のサイトから入手する事ができます。</p>
<pre><code>-- For RHEL9
# dnf install https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm

-- For RHEL8
# dnf install https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm

-- For Rocky8/Rocky9
# dnf install epel-release
</code></pre>
<h4 id="red-hat-codeready-linux-builder">Red Hat CodeReady Linux Builder</h4>
<p>MOFED（Mellanox OpenFabrics Enterprise Distribution）ドライバのインストールには、Red Hat Enterprise Linux 8.xの標準インストール構成では無効化されている Red Hat CodeReady Linux Builder リポジトリを有効化する必要があります。Rokey Linuxにおいては、このリポジトリは PowerTools と呼ばれています。</p>
<p>このリポジトリを有効化するには、以下のコマンドを実行します。</p>
<pre><code>-- For RHEL9
# subscription-manager repos --enable codeready-builder-for-rhel-9-x86_64-rpms

-- For Rocky9
# dnf config-manager --set-enabled crb

-- For RHEL8
# subscription-manager repos --enable codeready-builder-for-rhel-8-x86_64-rpms

-- For Rocky8
# dnf config-manager --set-enabled powertools
</code></pre>
<h2 id="mofed">MOFEDドライバのインストール</h2>
<p>MOFEDドライバは、<a href="https://network.nvidia.com/products/infiniband-drivers/linux/mlnx_ofed/">こちら</a>からダウンロードする事ができます。
本節では、MOFEDドライババージョン23.10のtgzアーカイブからのインストール例を紹介します。</p>
<p><img alt="MOFED Driver Selection" src="../img/mofed-download.png" /></p>
<p>MOFEDドライバのインストーラを実行するために、最低限<code>createrepo</code>および<code>perl</code>パッケージのインストールが必要です。</p>
<p>次にtgzアーカイブを展開し、<code>mlnxofedinstall</code>スクリプトを実行します。この時、GPUDirect Storageのサポートを有効化するオプションを付加するのを忘れないでください。</p>
<pre><code># dnf install -y perl createrepo
# tar zxvf MLNX_OFED_LINUX-23.10-2.1.3.1-rhel9.3-x86_64.tgz
# cd MLNX_OFED_LINUX-23.10-2.1.3.1-rhel9.3-x86_64
# ./mlnxofedinstall --with-nvmf --with-nfsrdma --add-kernel-support
# dracut -f
</code></pre>
<p>MOFEDドライバのビルドおよびインストール中、不足パッケージのインストールを要求される事があります。
その場合、エラーメッセージを確認して要求されたパッケージの追加インストールを行ってください。</p>
<pre><code>Error: One or more required packages for installing OFED-internal are missing.
Please install the missing packages using your Linux distribution Package Management tool.
Run:
yum install kernel-rpm-macros
Failed to build MLNX_OFED_LINUX for 5.14.0-362.8.1.el9_3.x86_64
</code></pre>
<p>MOFEDドライバのインストールが完了すると、nvmeドライバなど、OS標準のものが置き換えられているはずです。</p>
<p>例えば以下の例では、OS標準の<code>nvme-rdma</code>ドライバ（<code>/lib/modules/&lt;KERNEL_VERSION&gt;/kernel/drivers/nvme/host/nvme-rdma.ko.xz</code>）ではなく、追加インストールされた<code>/lib/modules/&lt;KERNEL_VERSION&gt;/extra/mlnx-nvme/host/nvme-rdma.ko</code>が優先して使用されています。</p>
<pre><code>$ modinfo nvme-rdma
filename:       /lib/modules/5.14.0-427.18.1.el9_4.x86_64/extra/mlnx-nvme/host/nvme-rdma.ko
license:        GPL v2
rhelversion:    9.4
srcversion:     16C0049F26768D6EA12771B
depends:        nvme-core,rdma_cm,ib_core,nvme-fabrics,mlx_compat
retpoline:      Y
name:           nvme_rdma
vermagic:       5.14.0-427.18.1.el9_4.x86_64 SMP preempt mod_unload modversions
parm:           register_always:Use memory registration even for contiguous memory regions (bool)
</code></pre>
<p>既にロードされているカーネルモジュール（例: <code>nvme</code>）を置き換えるため、ここで一度システムのシャットダウンと再起動を行います。</p>
<p><code>mlnxofedinstall</code>スクリプトの完了後に、<code>dracut -f</code>を実行するのを忘れないでください。</p>
<div class="admonition tips">
<p class="admonition-title">Tips</p>
<p><strong>Linux kernelのバージョンアップとMOFEDドライバ</strong></p>
<p>RHEL系列のディストリビューションにおいて、MODEDドライバはDKMS(Dynamic Kernel Module Support)を使用しません。
そのため、Linux kernelをバージョンアップした場合には、上記の手順を再度実行し、新しいLinux kernelに対応したMOFEDドライバを再インストールする必要があります。</p>
<p>後述のCUDA Toolkitのインストールなど、パッケージ更新のタイミングでLinux kernelがアップデートされる事もありますが、その場合でも同様です。</p>
</div>
<h3 id="heterodb-swdc">heterodb-swdcのインストール</h3>
<p>PG-Stromほか関連パッケージは<a href="https://heterodb.github.io/swdc/">HeteroDB Software Distribution Center</a>から配布されています。
これらのソフトウェアを入手するために、HeteroDB-SWDCのリポジトリ定義をyumシステムに追加する必要があります。</p>
<p>HeteroDB-SWDCリポジトリの定義はheterodb-swdcパッケージにより提供されます。
Webブラウザなどで<a href="https://heterodb.github.io/swdc/">HeteroDB Software Distribution Center</a>へアクセスし、ページの先頭にリンクの記載されている<code>heterodb-swdc-1.3-1.el9.noarch.rpm</code>をダウンロードしてインストールしてください。（RHEL8の場合は<code>heterodb-swdc-1.3-1.el8.noarch.rpm</code>）
heterodb-swdcパッケージがインストールされると、HeteroDB-SWDCからソフトウェアを入手するためのyumシステムへの設定が追加されます。</p>
<p>以下のようにheterodb-swdcパッケージをインストールします。</p>
<pre><code># dnf install https://heterodb.github.io/swdc/yum/rhel8-noarch/heterodb-swdc-1.2-1.el8.noarch.rpm
</code></pre>
<h2 id="cuda-toolkit">CUDA Toolkitのインストール</h2>
<p>本節ではCUDA Toolkitのインストールについて説明します。 既に最新のCUDA Toolkitをインストール済みである場合、本節の初期設定と合致しているかどうか確認してください。</p>
<p>NVIDIAはCUDA Toolkitのインストールに２通りの方法を提供しています。一つは自己実行型アーカイブ（runfile）によるもの。もう一つはRPMパッケージによるもので、PG-StromのセットアップにはRPMパッケージによるインストールを推奨します。</p>
<p>CUDA Toolkitのインストール用パッケージはNVIDIA DEVELOPER ZONEからダウンロードする事ができます。 適切なOS、アーキテクチャ、ディストリビューション、バージョンを指定し、『rpm(network)』版を選択してください。</p>
<p><img alt="CUDA Toolkit download" src="../img/cuda-download.png" /></p>
<p>『rpm(network)』を選択すると、リポジトリを登録し、ネットワーク経由でパッケージをインストールするためのシェルコマンドが表示されます。ガイダンス通りにインストールを進めてください。</p>
<pre><code># dnf config-manager --add-repo https://developer.download.nvidia.com/compute/cuda/repos/rhel9/x86_64/cuda-rhel9.repo
# dnf clean all
# dnf install cuda-toolkit-12-5
</code></pre>
<p>CUDA Toolkitのインストールに続いて、ドライバをインストールのためのコマンドが２種類表示されています。
ここでは<strong>オープンソース版のnvidia-driver</strong>を使用してください。オープンソース版のみがGPUDirect Storage機能をサポートしており、PG-StromのGPU-Direct SQLは本機能を利用しています。</p>
<div class="admonition tips">
<p class="admonition-title">Tips</p>
<p><strong>Volta以前のGPUの利用について</strong></p>
<p>オープンソース版nvidiaドライバは、Volta世代以前のGPUには対応していません。
したがって、VoltaまたはPascal世代のGPUでPG-Stromを利用する場合は、プロプラエタリ版のドライバであってもGPUDirect Storageに対応しているCUDA 12.2 Update 1を利用する必要があります。
CUDA 12.2 Update 1のパッケージは<a href="https://developer.nvidia.com/cuda-12-2-1-download-archive?target_os=Linux&amp;target_arch=x86_64&amp;Distribution=RHEL&amp;target_version=8&amp;target_type=rpm_local">こちら</a>から入手する事ができます。</p>
</div>
<p>続いて、GPU-Direct Storage(GDS)を利用するためのドライバモジュール<code>nvidia-gds</code>をインストールします。
パッケージ名に続いてCUDA Toolkitのバージョンと同一のバージョン名を指定してください。</p>
<pre><code># dnf module install nvidia-driver:open-dkms
# dnf install nvidia-gds-12-5
</code></pre>
<p>正常にインストールが完了すると、<code>/usr/local/cuda</code>配下にCUDA Toolkitが導入されています。</p>
<pre><code>$ ls /usr/local/cuda/
bin/                            gds/      nsightee_plugins/  targets/
compute-sanitizer/              include@ nvml/              tools/
CUDA_Toolkit_Release_Notes.txt  lib64@   nvvm/              version.json
DOCS                            libnvvp/  README
EULA.txt                        LICENSE   share/
extras/                         man/      src/
</code></pre>
<p>インストールが完了したら、GPUが正しく認識されている事を確認してください。<code>nvidia-smi</code>コマンドを実行すると、以下の出力例のように、システムに搭載されているGPUの情報が表示されます。</p>
<pre><code>$ nvidia-smi
Mon Jun  3 09:56:41 2024
+-----------------------------------------------------------------------------------------+
| NVIDIA-SMI 555.42.02              Driver Version: 555.42.02      CUDA Version: 12.5     |
|-----------------------------------------+------------------------+----------------------+
| GPU  Name                 Persistence-M | Bus-Id          Disp.A | Volatile Uncorr. ECC |
| Fan  Temp   Perf          Pwr:Usage/Cap |           Memory-Usage | GPU-Util  Compute M. |
|                                         |                        |               MIG M. |
|=========================================+========================+======================|
|   0  NVIDIA A100-PCIE-40GB          Off |   00000000:41:00.0 Off |                    0 |
| N/A   58C    P0             66W /  250W |       1MiB /  40960MiB |      0%      Default |
|                                         |                        |             Disabled |
+-----------------------------------------+------------------------+----------------------+

+-----------------------------------------------------------------------------------------+
| Processes:                                                                              |
|  GPU   GI   CI        PID   Type   Process name                              GPU Memory |
|        ID   ID                                                               Usage      |
|=========================================================================================|
|  No running processes found                                                             |
+-----------------------------------------------------------------------------------------+
</code></pre>
<div class="admonition tips">
<p class="admonition-title">Tips</p>
<p><strong>NVSwitch搭載システムの追加設定</strong></p>
<p>複数のGPUを搭載し、それらのインターコネクトにNVSwitchを使用するシステムでは、<code>nvidia-fabricmanager</code>モジュールの追加インストールが必要です。このパッケージがインストールされていない場合、CUDAの初期化を行う<code>cuInit()</code>が<code>CUDA_ERROR_SYSTEM_NOT_READY</code>エラーで失敗し、PG-Stromを起動する事ができません。
以下のコマンドで<code>nvidia-fabricmanager</code>を追加インストールしてください。
<a href="https://docs.nvidia.com/gpudirect-storage/troubleshooting-guide/index.html#cuda-error-system-not-ready-after-installation">(参考情報)</a></p>
</div>
<pre><code># dnf install nvidia-fabricmanager
# systemctl enable nvidia-fabricmanager.service
# systemctl start nvidia-fabricmanager.service
</code></pre>
<h3 id="gpudirect-storage">GPUDirect Storageの確認</h3>
<p>上記の手順でCUDA Toolkitのインストールが完了すると、GPUDirect Storageが利用可能な状態となっているはずです。
以下の通り、<code>gdscheck</code>ツールを用いてストレージデバイス毎のコンフィグを確認してください。
（この例では、<code>nvme</code>だけでなく、<code>nvme-rdma</code>や<code>rpcrdma</code>カーネルモジュールもロードしているため、関連する機能が<code>Supported</code>となっています）</p>
<pre><code># /usr/local/cuda/gds/tools/gdscheck -p
 GDS release version: 1.10.0.4
 nvidia_fs version:  2.20 libcufile version: 2.12
 Platform: x86_64
 ============
 ENVIRONMENT:
 ============
 =====================
 DRIVER CONFIGURATION:
 =====================
 NVMe               : Supported
 NVMeOF             : Supported
 SCSI               : Unsupported
 ScaleFlux CSD      : Unsupported
 NVMesh             : Unsupported
 DDN EXAScaler      : Unsupported
 IBM Spectrum Scale : Unsupported
 NFS                : Supported
 BeeGFS             : Unsupported
 WekaFS             : Unsupported
 Userspace RDMA     : Unsupported
 --Mellanox PeerDirect : Disabled
 --rdma library        : Not Loaded (libcufile_rdma.so)
 --rdma devices        : Not configured
 --rdma_device_status  : Up: 0 Down: 0
 =====================
 CUFILE CONFIGURATION:
 =====================
 properties.use_compat_mode : true
 properties.force_compat_mode : false
 properties.gds_rdma_write_support : true
 properties.use_poll_mode : false
 properties.poll_mode_max_size_kb : 4
 properties.max_batch_io_size : 128
 properties.max_batch_io_timeout_msecs : 5
 properties.max_direct_io_size_kb : 16384
 properties.max_device_cache_size_kb : 131072
 properties.max_device_pinned_mem_size_kb : 33554432
 properties.posix_pool_slab_size_kb : 4 1024 16384
 properties.posix_pool_slab_count : 128 64 32
 properties.rdma_peer_affinity_policy : RoundRobin
 properties.rdma_dynamic_routing : 0
 fs.generic.posix_unaligned_writes : false
 fs.lustre.posix_gds_min_kb: 0
 fs.beegfs.posix_gds_min_kb: 0
 fs.weka.rdma_write_support: false
 fs.gpfs.gds_write_support: false
 profile.nvtx : false
 profile.cufile_stats : 0
 miscellaneous.api_check_aggressive : false
 execution.max_io_threads : 4
 execution.max_io_queue_depth : 128
 execution.parallel_io : true
 execution.min_io_threshold_size_kb : 8192
 execution.max_request_parallelism : 4
 properties.force_odirect_mode : false
 properties.prefer_iouring : false
 =========
 GPU INFO:
 =========
 GPU index 0 NVIDIA A100-PCIE-40GB bar:1 bar size (MiB):65536 supports GDS, IOMMU State: Disabled
 ==============
 PLATFORM INFO:
 ==============
 IOMMU: disabled
 Nvidia Driver Info Status: Supported(Nvidia Open Driver Installed)
 Cuda Driver Version Installed:  12050
 Platform: AS -2014CS-TR, Arch: x86_64(Linux 5.14.0-427.18.1.el9_4.x86_64)
 Platform verification succeeded
</code></pre>
<div class="admonition tips">
<p class="admonition-title">Tips</p>
<p><strong>RAIDを使用する場合の追加設定</strong></p>
<p>GPUDirect Storageを利用してSoftware RAID (md-raid0) 区画からデータを読み出す場合、
以下の一行を<code>/lib/udev/rules.d/63-md-raid-arrays.rules</code> 設定に追加する必要があります。</p>
<p><code>IMPORT{​program}="/usr/sbin/mdadm --detail --export $devnode"</code></p>
<p>その後、設定を反映させるためにシステムを再起動してください。
詳しくは<a href="https://docs.nvidia.com/gpudirect-storage/troubleshooting-guide/index.html#adding-udev-rules">NVIDIA GPUDirect Storage Installation and Troubleshooting Guide</a>を参照してください。</p>
</div>
<h3 id="pci-bar1">PCI Bar1メモリの設定</h3>
<p>GPU-Direct SQLは、GPUデバイスメモリをホストシステム上のPCI BAR1領域（物理アドレス空間）にマップし、そこをDestinationとするP2P-RDMA要求をNVME機器に対して行う事で、ロスのない高速なデータ読出しを実現します。</p>
<p>十分な多重度を持ったP2P-RDMAを行うには、GPUがバッファをマップするのに十分なPCI BAR1領域を有している必要があります。大半のGPUではPCI BAR1領域の大きさは固定で、PG-Stromにおいては、それがGPUデバイスメモリのサイズを上回っている製品を推奨しています。</p>
<p>しかし、一部のGPU製品においては『動作モード』を切り替える事でPCI BAR1領域のサイズを切り替える事ができるものが存在します。お使いのGPUがそれに該当する場合は、<a href="https://developer.nvidia.com/displaymodeselector">NVIDIA Display Mode Selector Tool</a>を参照の上、PCI BAR1領域のサイズを最大化するモードへと切り替えてください。</p>
<p>2023年12月時点では、以下のGPUの場合にNVIDIA Display Mode Selector Toolを利用して<strong>*Display Off</strong>モードへと切り替える必要があります。</p>
<ul>
<li>NVIDIA L40S</li>
<li>NVIDIA L40</li>
<li>NVIDIA A40</li>
<li>NVIDIA RTX 6000 Ada</li>
<li>NVIDIA RTX A6000</li>
<li>NVIDIA RTX A5500</li>
<li>NVIDIA RTX A5000</li>
</ul>
<p>システムに搭載されているGPUのメモリサイズやPCI BAR1サイズを確認するには、<code>nvidia-smi -q</code>コマンドを利用します。以下のように、メモリ関連の状態が表示されます。</p>
<pre><code>$ nvidia-smi -q
        :
    FB Memory Usage
        Total                             : 46068 MiB
        Reserved                          : 685 MiB
        Used                              : 4 MiB
        Free                              : 45377 MiB
    BAR1 Memory Usage
        Total                             : 65536 MiB
        Used                              : 1 MiB
        Free                              : 65535 MiB
        :
</code></pre>
<h2 id="heterodb">HeteroDB 拡張モジュール</h2>
<p><code>heterodb-extra</code>モジュールは、PG-Stromに以下の機能を追加します。</p>
<ul>
<li>マルチGPUの対応</li>
<li>GPUダイレクトSQL</li>
<li>GiSTインデックス対応</li>
<li>ライセンス管理機能</li>
</ul>
<p>これらの機能を使用せず、オープンソース版の機能のみを使用する場合は <code>heterodb-extra</code> モジュールのインストールは不要です。
本節の内容は読み飛ばして構いません。</p>
<p>以下のように、SWDCから<code>heterodb-extra</code>パッケージをインストールしてください。</p>
<pre><code># dnf install heterodb-extra
</code></pre>
<h3 id="_5">ライセンスの有効化</h3>
<p><code>heterodb-extra</code>モジュールの全ての機能を利用するには、HeteroDB社が提供するライセンスの有効化が必要です。ライセンスなしで運用する事も可能ですが、その場合、下記の機能が制限を受けます。</p>
<ul>
<li>マルチGPUの利用</li>
<li>GPUダイレクトSQLにおける複数NVME-SSDによるストライピング(md-raid0)</li>
<li>GPUダイレクトSQLにおけるNVME-oFデバイスの利用</li>
<li>GPU版PostGISにおけるGiSTインデックスの利用</li>
</ul>
<p>ライセンスファイルは以下のような形式でHeteroDB社から入手する事ができます。</p>
<pre><code>IAgIVdKxhe+BSer3Y67jQW0+uTzYh00K6WOSH7xQ26Qcw8aeUNYqJB9YcKJTJb+QQhjmUeQpUnboNxVwLCd3HFuLXeBWMKp11/BgG0FSrkUWu/ZCtDtw0F1hEIUY7m767zAGV8y+i7BuNXGJFvRlAkxdVO3/K47ocIgoVkuzBfLvN/h9LffOydUnHPzrFHfLc0r3nNNgtyTrfvoZiXegkGM9GBTAKyq8uWu/OGonh9ybzVKOgofhDLk0rVbLohOXDhMlwDl2oMGIr83tIpCWG+BGE+TDwsJ4n71Sv6n4bi/ZBXBS498qShNHDGrbz6cNcDVBa+EuZc6HzZoF6UrljEcl=
----
VERSION:2
SERIAL_NR:HDB-TRIAL
ISSUED_AT:2019-05-09
EXPIRED_AT:2019-06-08
GPU_UUID:GPU-a137b1df-53c9-197f-2801-f2dccaf9d42f
</code></pre>
<p>これを <code>/etc/heterodb.license</code> にコピーし、PostgreSQLを再起動します。</p>
<p>以下のようにPostgreSQLの起動ログにライセンス情報が出力され、ライセンスの有効化が行われた事が分かります。</p>
<pre><code>    :
 LOG:  HeteroDB Extra module loaded [api_version=20231105,cufile=on,nvme_strom=off,githash=9ca2fe4d2fbb795ad2d741dcfcb9f2fe499a5bdf]
 LOG:  HeteroDB License: { &quot;version&quot; : 2, &quot;serial_nr&quot; : &quot;HDB-TRIAL&quot;, &quot;issued_at&quot; : &quot;2022-11-19&quot;, &quot;expired_at&quot; : &quot;2099-12-31&quot;, &quot;nr_gpus&quot; : 1, &quot;gpus&quot; : [ { &quot;uuid&quot; : &quot;GPU-13943bfd-5b30-38f5-0473-78979c134606&quot; } ]}
 LOG:  PG-Strom version 5.0.1 built for PostgreSQL 15 (githash: 972441dbafed6679af86af40bc8613be2d73c4fd)
    :
</code></pre>
<h2 id="postgresql">PostgreSQLのインストール</h2>
<p>本節ではRPMによるPostgreSQLのインストールについて紹介します。
ソースからのインストールに関しては既にドキュメントが数多く存在し、<code>./configure</code>スクリプトのオプションが多岐にわたる事から、ここでは紹介しません。</p>
<p>Linuxディストリビューションの配布するパッケージにもPostgreSQLは含まれていますが、必ずしも最新ではなく、PG-Stromの対応バージョンよりも古いものである事が多々あります。例えば、Red Hat Enterprise Linux 7.xで配布されているPostgreSQLはv9.2.xですが、これはPostgreSQLコミュニティとして既にEOLとなっているバージョンです。</p>
<p>PostgreSQL Global Development Groupは、最新のPostgreSQLおよび関連ソフトウェアの配布のためにyumリポジトリを提供しています。
EPELの設定のように、yumリポジトリの設定を行うだけの小さなパッケージをインストールし、その後、PostgreSQLやその他のソフトウェアをインストールします。</p>
<p>yumリポジトリ定義の一覧は <a href="http://yum.postgresql.org/repopackages.php">http://yum.postgresql.org/repopackages.php</a> です。</p>
<p>PostgreSQLメジャーバージョンとLinuxディストリビューションごとに多くのリポジトリ定義がありますが、あなたのLinuxディストリビューション向けのPostgreSQL 15以降のものを選択する必要があります。</p>
<p>以下のステップで PostgreSQL のインストールを行います。</p>
<ul>
<li>yumリポジトリの定義をインストール</li>
<li>OS標準のPostgreSQLモジュールの無効化</li>
<li>PostgreSQLパッケージのインストール</li>
</ul>
<p>例えばPostgreSQL v16を使用する場合、PG-Stromのインストールには <code>postgresql16-server</code>および<code>postgresql16-devel</code>パッケージが必要です。</p>
<p>以下は、RHEL9においてPostgreSQL v16をインストールする手順の例です。</p>
<pre><code># dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-9-x86_64/pgdg-redhat-repo-latest.noarch.rpm
# dnf -y module disable postgresql
# dnf install -y postgresql16-devel postgresql16-server
</code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Red Hat Enterprise Linuxの場合、パッケージ名<code>postgresql</code>がディストリビューション標準のものと競合してしまい、PGDG提供のパッケージをインストールする事ができません。そのため、<code>dnf -y module disable postgresql</code> コマンドを用いてディストリビューション標準の<code>postgresql</code>モジュールを無効化します。</p>
</div>
<h2 id="libarrowlibparquet">libarrow/libparquetのインストール</h2>
<p>PG-Strom v6.1以降では、ビルドとインストールに<code>libarrow</code>と<code>libparquet</code>が必要です。</p>
<p>Linuxディストリビューションの提供しているパッケージは古い場合があるため、<a href="https://arrow.apache.org/install/">開発者コミュニティのガイダンス</a>にしたがって、<code>arrow-devel</code>パッケージと<code>parquet-devel</code>パッケージをインストールしてください。</p>
<p>ここまでのインストール手順との重複を除く、最小インストールに必要なステップは以下の通りです。</p>
<pre><code>$ sudo dnf install -y https://packages.apache.org/artifactory/arrow/almalinux/$(cut -d: -f5 /etc/system-release-cpe | cut -d. -f1)/apache-arrow-release-latest.rpm
$ sudo dnf install -y arrow-devel
$ sudo dnf install -y parquet-devel
</code></pre>
<h2 id="pg-strom">PG-Stromのインストール</h2>
<p>本節ではPG-Stromのインストール方法について説明します。
推奨はRPMによるインストールですが、開発者向けにソースコードからのビルド方法についても紹介します。</p>
<h3 id="rpm">RPMによるインストール</h3>
<p>PG-Stromおよび関連パッケージは<a href="https://heterodb.github.io/swdc/">HeteroDB Software Distribution Center</a>より配布されています。
既にyumシステムへリポジトリを追加済みであれば、それほど作業は多くありません。</p>
<p>基盤となるPostgreSQLのバージョンごとに別個のPG-StromのRPMパッケージが準備されており、PostgreSQL v15用であれば<code>pg_strom-PG15</code>パッケージを、PostgreSQL v16用であれば<code>pg_strom-PG16</code>パッケージをインストールします。</p>
<p>これは、PostgreSQL拡張モジュールのバイナリ互換性に伴う制約です。</p>
<pre><code># dnf install -y pg_strom-PG16
</code></pre>
<p>以上でパッケージのインストールは完了です。</p>
<h3 id="_6">ソースからのインストール</h3>
<p>開発者向けに、ソースコードからPG-Stromをビルドする方法についても紹介します。</p>
<h4 id="_7">ソースコードの入手</h4>
<p>RPMパッケージと同様に、ソースコードのtarballを<a href="https://heterodb.github.io/swdc/">HeteroDB Software Distribution Center</a>から入手する事ができます。</p>
<p>ただ、tarballのリリースにはある程度のタイムラグが生じてしまうため、最新の開発版を使いたい場合には<a href="https://github.com/heterodb/pg-strom">PG-StromのGitHubリポジトリ</a>の<code>master</code>ブランチをチェックアウトする方法の方が好まれるかもしれません。</p>
<pre><code>$ git clone https://github.com/heterodb/pg-strom.git
Cloning into 'pg-strom'...
remote: Counting objects: 13797, done.
remote: Compressing objects: 100% (215/215), done.
remote: Total 13797 (delta 208), reused 339 (delta 167), pack-reused 13400
Receiving objects: 100% (13797/13797), 11.81 MiB | 1.76 MiB/s, done.
Resolving deltas: 100% (10504/10504), done.
</code></pre>
<h4 id="pg-strom_1">PG-Stromのビルド</h4>
<p>PG-Stromをビルドする時のコンフィグは、インストール先のPostgreSQLと厳密に一致していなければいけません。例えば、同じ構造体がビルド時のコンフィグによりPostgreSQLとPG-Stromで異なったレイアウトを持ってしまったとすれば、非常に発見の難しいバグを生み出してしまうかもしれません。 したがって、（一貫性のない状態を避けるため）PG-Stromは独自にconfigureスクリプトを走らせたりはせず、<code>pg_config</code>を使ってPostgreSQLのビルド時設定を参照します。</p>
<p><code>pg_config</code>にパスが通っており、それがインストール先のPostgreSQLのものであれば、そのまま<code>make</code>、<code>make install</code>を実行します。
直接パスが通っていない場合は、<code>make</code>コマンドに<code>PG_CONFIG=...</code>パラメータを与え、<code>pg_config</code>のフルパスを渡します。</p>
<pre><code>$ cd pg-strom/src
$ make PG_CONFIG=/usr/pgsql-16/bin/pg_config
$ sudo make install PG_CONFIG=/usr/pgsql-16/bin/pg_config
</code></pre>
<h3 id="_8">インストール後の設定</h3>
<h3 id="_9">データベースクラスタの作成</h3>
<p>データベースクラスタの作成が済んでいない場合は、<code>initdb</code>コマンドを実行してPostgreSQLの初期データベースを作成します。</p>
<p>RPMインストールにおけるデフォルトのデータベースクラスタのパスは<code>/var/lib/pgsql/&lt;version number&gt;/data</code>です。
<code>postgresql-alternatives</code>パッケージをインストールしている場合は、PostgreSQLのバージョンに拠らず<code>/var/lib/pgdata</code>で参照する事ができます。</p>
<pre><code># su - postgres
$ /usr/pgsql-16/bin/initdb -D /var/lib/pgdata/
The files belonging to this database system will be owned by user &quot;postgres&quot;.
This user must also own the server process.

The database cluster will be initialized with locale &quot;en_US.UTF-8&quot;.
The default database encoding has accordingly been set to &quot;UTF8&quot;.
The default text search configuration will be set to &quot;english&quot;.

Data page checksums are disabled.

fixing permissions on existing directory /var/lib/pgdata ... ok
creating subdirectories ... ok
selecting dynamic shared memory implementation ... posix
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting default time zone ... Asia/Tokyo
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
syncing data to disk ... ok

initdb: warning: enabling &quot;trust&quot; authentication for local connections
You can change this by editing pg_hba.conf or using the option -A, or
--auth-local and --auth-host, the next time you run initdb.

Success. You can now start the database server using:

    pg_ctl -D /var/lib/pgdata/ -l logfile start
</code></pre>
<h3 id="postgresqlconf">postgresql.confの編集</h3>
<p>続いて、PostgreSQLの設定ファイルである <code>postgresql.conf</code> を編集します。</p>
<p>PG-Stromを動作させるためには、最低限、以下のパラメータの設定が必要です。
これ以外のパラメータについても、システムの用途や想定ワークロードを踏まえて検討してください。</p>
<ul>
<li><strong>shared_preload_libraries</strong><ul>
<li>PG-Stromモジュールは<code>shared_preload_libraries</code>パラメータによりpostmasterプロセスの起動時にロードされる必要があります。オンデマンドでの拡張モジュールのロードはサポート対象外です。したがって、以下の設定項目は必須です。</li>
<li><code>shared_preload_libraries = '$libdir/pg_strom'</code></li>
</ul>
</li>
<li><strong>max_worker_processes</strong><ul>
<li>PG-Stromは数個のバックグラウンドワーカーを内部的に使用します。そのため、デフォルト値である 8 では、それ以外の処理に利用できるバックグラウンドワーカープロセス数があまりにも少なすぎてしまいます。</li>
<li>以下のように、ある程度の余裕を持った値を設定すべきです。</li>
<li><code>max_worker_processes = 100</code></li>
</ul>
</li>
<li><strong>shared_buffers</strong><ul>
<li>ワークロードによりますが、<code>shared_buffers</code>の初期設定は非常に小さいため、PG-Stromが有効に機能する水準のデータサイズに対しては、ストレージへの読み書きが律速要因となってしまい、GPUの並列計算機能を有効に利用できない可能性があります。</li>
<li>以下のように、ある程度の余裕を持った値を設定すべきです。</li>
<li><code>shared_buffers = 10GB</code></li>
<li>明らかにメモリサイズよりも大きなデータを処理する必要がある場合は、SSD-to-GPUダイレクトSQL実行の利用を検討してください。</li>
</ul>
</li>
<li><strong>work_mem</strong><ul>
<li>ワークロードによりますが、<code>work_mem</code>の初期設定は非常に小さいため、解析系クエリで最適なクエリ実行計画が選択されない可能性があります。</li>
<li>典型的な例は、ソート処理にオンメモリのクイックソートではなく、ディスクベースのマージソートを選択するといったものです。</li>
<li>以下のように、ある程度の余裕を持った値を設定すべきです。</li>
<li><code>work_mem = 1GB</code></li>
</ul>
</li>
</ul>
<h3 id="os_1">OSのリソース制限の拡張</h3>
<p>GPUダイレクトSQLを使用する場合は特に、同時に大量のファイルをオープンする事があるため、プロセスあたりファイルディスクリプタ数の上限を拡大しておく必要があります。</p>
<p>また、PostgreSQLのクラッシュ時に確実にコアダンプを生成できるよう、コアファイルのサイズ上限を制限しないことを推奨します。</p>
<p>PostgreSQLをsystemd経由で起動する場合、リソース制限に関する設定は<code>/etc/systemd/system/postgresql-XX.service.d/pg_strom.conf</code>に記述します。</p>
<p>RPMによるインストールの場合、デフォルトで以下の内容が設定されます。</p>
<p>環境変数 <code>CUDA_ENABLE_COREDUMP_ON_EXCEPTION</code> に関する設定がコメントアウトされています。これは開発者向けのオプションで、これを有効にして起動すると、GPU側でエラーが発生した場合にGPUのコアダンプを生成させる事ができます。詳しくは<a href="https://docs.nvidia.com/cuda/cuda-gdb/index.html#gpu-coredump">CUDA-GDB:GPU core dump support</a>をご覧ください。</p>
<pre><code>[Service]
LimitNOFILE=65536
LimitCORE=infinity
#Environment=CUDA_ENABLE_COREDUMP_ON_EXCEPTION=1
</code></pre>
<h3 id="postgresql_1">PostgreSQLの起動</h3>
<p>PostgreSQLを起動します。</p>
<p>正常にセットアップが完了していれば、ログにPG-StromがGPUを認識した事を示すメッセージが記録されているはずです。
以下の例では、NVIDIA A100 (PCIE版; 40GB) を認識しており、また、NVME-SSDごとに近傍のGPUがどちらであるのか出力されています。</p>
<pre><code># systemctl start postgresql-16
# journalctl -u postgresql-16
Jun 02 17:28:45 buri.heterodb.com postgres[20242]: 2024-06-02 17:28:45.989 JST [20242] LOG:  HeteroDB Extra module loaded [api_version=20240418,cufile=off,nvme_strom=off,githash=3ffc65428c07bb3c9d0e5c75a2973389f91dfcd4]
Jun 02 17:28:45 buri.heterodb.com postgres[20242]: 2024-06-02 17:28:45.989 JST [20242] LOG:  HeteroDB License: { &quot;version&quot; : 2, &quot;serial_nr&quot; : &quot;HDB-TRIAL&quot;, &quot;issued_at&quot; : &quot;2024-06-02&quot;, &quot;expired_at&quot; : &quot;2099-12-31&quot;, &quot;nr_gpus&quot; : 1, &quot;gpus&quot; : [ { &quot;uuid&quot; : &quot;GPU-13943bfd-5b30-38f5-0473-78979c134606&quot; } ]}
Jun 02 17:28:45 buri.heterodb.com postgres[20242]: 2024-06-02 17:28:45.989 JST [20242] LOG:  PG-Strom version 5.12.el9 built for PostgreSQL 16 (githash: )
Jun 02 17:28:48 buri.heterodb.com postgres[20242]: 2024-06-02 17:28:48.114 JST [20242] LOG:  PG-Strom binary built for CUDA 12.4 (CUDA runtime 12.5)
Jun 02 17:28:48 buri.heterodb.com postgres[20242]: 2024-06-02 17:28:48.114 JST [20242] WARNING:  The CUDA version where this PG-Strom module binary was built for (12.4) is newer than the CUDA runtime version on this platform (12.5). It may lead unexpected behavior, and upgrade of CUDA toolkit is recommended.
Jun 02 17:28:48 buri.heterodb.com postgres[20242]: 2024-06-02 17:28:48.114 JST [20242] LOG:  PG-Strom: GPU0 NVIDIA A100-PCIE-40GB (108 SMs; 1410MHz, L2 40960kB), RAM 39.50GB (5120bits, 1.16GHz), PCI-E Bar1 64GB, CC 8.0
Jun 02 17:28:48 buri.heterodb.com postgres[20242]: 2024-06-02 17:28:48.117 JST [20242] LOG:  [0000:41:00:0] GPU0 (NVIDIA A100-PCIE-40GB; GPU-13943bfd-5b30-38f5-0473-78979c134606)
Jun 02 17:28:48 buri.heterodb.com postgres[20242]: 2024-06-02 17:28:48.117 JST [20242] LOG:  [0000:81:00:0] nvme6 (NGD-IN2500-080T4-C) --&gt; GPU0 [dist=9]
Jun 02 17:28:48 buri.heterodb.com postgres[20242]: 2024-06-02 17:28:48.117 JST [20242] LOG:  [0000:82:00:0] nvme3 (INTEL SSDPF2KX038TZ) --&gt; GPU0 [dist=9]
Jun 02 17:28:48 buri.heterodb.com postgres[20242]: 2024-06-02 17:28:48.117 JST [20242] LOG:  [0000:c2:00:0] nvme1 (INTEL SSDPF2KX038TZ) --&gt; GPU0 [dist=9]
Jun 02 17:28:48 buri.heterodb.com postgres[20242]: 2024-06-02 17:28:48.117 JST [20242] LOG:  [0000:c6:00:0] nvme4 (Corsair MP600 CORE) --&gt; GPU0 [dist=9]
Jun 02 17:28:48 buri.heterodb.com postgres[20242]: 2024-06-02 17:28:48.117 JST [20242] LOG:  [0000:c3:00:0] nvme5 (INTEL SSDPF2KX038TZ) --&gt; GPU0 [dist=9]
Jun 02 17:28:48 buri.heterodb.com postgres[20242]: 2024-06-02 17:28:48.117 JST [20242] LOG:  [0000:c1:00:0] nvme0 (INTEL SSDPF2KX038TZ) --&gt; GPU0 [dist=9]
Jun 02 17:28:48 buri.heterodb.com postgres[20242]: 2024-06-02 17:28:48.117 JST [20242] LOG:  [0000:c4:00:0] nvme2 (NGD-IN2500-080T4-C) --&gt; GPU0 [dist=9]
Jun 02 17:28:48 buri.heterodb.com postgres[20242]: 2024-06-02 17:28:48.217 JST [20242] LOG:  redirecting log output to logging collector process
Jun 02 17:28:48 buri.heterodb.com postgres[20242]: 2024-06-02 17:28:48.217 JST [20242] HINT:  Future log output will appear in directory &quot;log&quot;.
Jun 02 17:28:48 buri.heterodb.com systemd[1]: Started PostgreSQL 16 database server.
</code></pre>
<h3 id="pg-strom_2">PG-Stromエクステンションの作成</h3>
<p>最後に、PG-Stromに関連するSQL関数などのDBオブジェクトを作成します。
この手順はPostgreSQLのEXTENSION機能を用いてパッケージ化されており、SQLコマンドラインで<code>CREATE EXTENSION</code>コマンドを実行するだけです。</p>
<p>なお、この手順は新しいデータベースを作成するたびに必要になる事に注意してください。
新しいデータベースを作成した時点で既にPG-Strom関連オブジェクトが作成されていてほしい場合は、予め<code>template1</code>データベースでPG-Stromエクステンションを作成しておけば、<code>CREATE DATABASE</code>コマンドの実行時に新しいデータベースへ設定がコピーされます。</p>
<pre><code>$ psql -U postgres
psql (16.3)
Type &quot;help&quot; for help.

postgres=# CREATE EXTENSION pg_strom ;
CREATE EXTENSION
</code></pre>
<p>以上でインストール作業は完了です。</p>
<h2 id="postgis">PostGISのインストール</h2>
<p>PG-Stromは一部のPostGIS関数のGPU処理をサポートしています。
本節ではPostGISのインストール手順について説明を行いますが、必要に応じて読み飛ばしてください。</p>
<p>PostgreSQLと同様に、PostgreSQL Global Development GroupのyumリポジトリからPostGISモジュールをインストールする事ができます。
以下の例は、PostgreSQL v16向けにビルドされたPostGIS v3.4をインストールするものです。</p>
<pre><code># dnf install postgis34_16
</code></pre>
<p>データベースクラスタを作成してPostgreSQLサーバを起動し、SQLクライアントから<code>CREATE EXTENSION</code>コマンドを実行してGeometryデータ型や地理情報分析のためのSQL関数を作成します。
これでPostGISのインストールは完了です。</p>
<pre><code>postgres=# CREATE EXTENSION postgis;
CREATE EXTENSION
</code></pre>
<h2 id="ubuntu-linux">Ubuntu Linuxへのインストール</h2>
<p>現在のところ、Ubuntu Linux向けのパッケージは提供されていませんが、ソースコードからPG-Stromをビルドして動作させることができます。</p>
<p>OSのインストール後、それぞれUbuntu Linux向けのMOFEDドライバ、CUDA Toolkit、およびPostgreSQLをインストールしてください。</p>
<p>続いて、<code>heterodb-extra</code>パッケージをインストールします。
Ubuntu Linux 用の <code>.deb</code> パッケージが提供されていますので、その時点の最新版を<a href="https://heterodb.github.io/swdc/">SWDC</a>より入手してください。</p>
<pre><code>$ wget https://heterodb.github.io/swdc/deb/heterodb-extra_5.4-1_amd64.deb
$ sudo dpkg -i heterodb-extra_5.4-1_amd64.deb
</code></pre>
<p>PG-Stromはソースコードをチェックアウトしてインストールします。
この時、ターゲットとするPostgreSQLの<code>pg_config</code>を指定するのを忘れないようにしてください。</p>
<p>インストール後の設定は Red Hat Enterprise Linux や Rocky Linux の場合とほぼ同じです。</p>
<pre><code>$ git clone https://github.com/heterodb/pg-strom.git
$ cd pg-strom/src
$ make PG_CONFIG=/path/to/pgsql/bin/pg_config -j 8
$ sudo make PG_CONFIG=/path/to/pgsql/bin/pg_config install
</code></pre>
<p>ただし、パッケージインストールしたPostgreSQLを使用してsystemctl経由でこれを起動する場合、PATH環境変数がクリアされてしまいます。（これはおそらくセキュリティ面での理由でしょう）
そのため、初回起動時にGPUバイナリをビルドするために起動したスクリプトが正しく動作しません。
これを避けるため、Ubuntu Linuxを利用する場合は<code>/etc/postgresql/PGVERSION/main/environment</code>に以下の内容を追記してください。</p>
<pre><code>/etc/postgresql/PGVERSION/main/environment:


PATH='/usr/local/cuda/bin:/usr/bin:/bin'
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href=".." class="btn btn-neutral float-left" title="はじめに"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../operations/" class="btn btn-neutral float-right" title="基本的な操作">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href=".." style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../operations/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
