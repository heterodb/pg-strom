---
--- Test for gpusort
---
\t on
SET pg_strom.regression_test_mode = on;
SET client_min_messages = error;
RESET client_min_messages;
SET search_path = regtest_dtype_range_temp,public;
-- Generate answer data
SET pg_strom.enabled = off;
DROP TABLE IF EXISTS gpusort_answer1;
NOTICE:  table "gpusort_answer1" does not exist, skipping
SELECT * INTO gpusort_answer1 FROM (
    SELECT c_region, c_nation, c_city, SUM(lo_revenue) lo_rev,
            RANK() OVER(PARTITION BY c_region, c_nation
                        ORDER BY SUM(lo_revenue)) rank
        FROM lineorder, customer
    WHERE lo_custkey = c_custkey
        AND lo_shipmode IN ('RAIL','SHIP')
        GROUP BY c_region, c_nation, c_city
) subqry
WHERE rank < 4;
DROP TABLE IF EXISTS gpusort_answer2;
NOTICE:  table "gpusort_answer2" does not exist, skipping
SELECT * INTO gpusort_answer2 FROM (
    SELECT c_region, c_nation, c_city, AVG(lo_revenue) lo_rev,
            DENSE_RANK() OVER(PARTITION BY c_region, c_nation
                        ORDER BY AVG(lo_revenue) desc) dense_rank
        FROM lineorder, customer
    WHERE lo_custkey = c_custkey
        AND lo_shipmode IN ('RAIL','SHIP')
        GROUP BY c_region, c_nation, c_city
) subqry
WHERE dense_rank <= 4;
DROP TABLE IF EXISTS gpusort_answer3;
NOTICE:  table "gpusort_answer3" does not exist, skipping
SELECT * INTO gpusort_answer3 FROM (
    SELECT c_region, c_nation, c_city, MAX(lo_revenue) lo_rev,
            ROW_NUMBER() OVER(PARTITION BY c_region, c_nation
                        ORDER BY MAX(lo_revenue)) row_number
        FROM lineorder, customer
    WHERE lo_custkey = c_custkey
        AND lo_shipmode IN ('RAIL','SHIP')
        GROUP BY c_region, c_nation, c_city
) subqry
WHERE row_number <= 4;
SET pg_strom.enabled = on;
SET pg_strom.cpu_fallback = off;
DROP TABLE IF EXISTS gpusort_result1;
NOTICE:  table "gpusort_result1" does not exist, skipping
EXPLAIN(costs off, verbose)
SELECT * INTO gpusort_result1 FROM (
    SELECT c_region, c_nation, c_city, SUM(lo_revenue) lo_rev,
            RANK() OVER(PARTITION BY c_region, c_nation
                        ORDER BY SUM(lo_revenue)) rank
        FROM lineorder, customer
    WHERE lo_custkey = c_custkey
        AND lo_shipmode IN ('RAIL','SHIP')
        GROUP BY c_region, c_nation, c_city
) subqry
WHERE rank < 4;
 WindowAgg
   Output: customer.c_region, customer.c_nation, customer.c_city, (pgstrom.fsum_numeric((pgstrom.psum(lineorder.lo_revenue)))), rank() OVER w1
   Window: w1 AS (PARTITION BY customer.c_region, customer.c_nation ORDER BY (pgstrom.fsum_numeric((pgstrom.psum(lineorder.lo_revenue)))) ROWS UNBOUNDED PRECEDING)
   Run Condition: (rank() OVER w1 < 4)
   ->  Gather
         Output: customer.c_region, customer.c_nation, customer.c_city, (pgstrom.fsum_numeric((pgstrom.psum(lineorder.lo_revenue))))
         Workers Planned: 2
         ->  Parallel Custom Scan (GpuPreAgg) on public.lineorder
               Output: customer.c_region, customer.c_nation, customer.c_city, pgstrom.fsum_numeric((pgstrom.psum(lineorder.lo_revenue)))
               GPU Projection: pgstrom.psum(lineorder.lo_revenue), customer.c_region, customer.c_nation, customer.c_city
               GPU Scan Quals: (lineorder.lo_shipmode = ANY ('{RAIL,SHIP}'::bpchar[]))
               GPU Join Quals [1]: (lineorder.lo_custkey = customer.c_custkey)
               GPU Outer Hash [1]: lineorder.lo_custkey
               GPU Inner Hash [1]: customer.c_custkey
               GPU Group Key: customer.c_region, customer.c_nation, customer.c_city
               GPU-Sort keys: customer.c_region ASC NULLS LAST, customer.c_nation ASC NULLS LAST, pgstrom.fsum_numeric((pgstrom.psum(lineorder.lo_revenue))) ASC NULLS LAST
               Window-Rank Filter: rank() over(PARTITION BY customer.c_region, customer.c_nation ORDER BY pgstrom.fsum_numeric((pgstrom.psum(lineorder.lo_revenue)))) < 4
               ->  Parallel Seq Scan on public.customer
                     Output: customer.c_region, customer.c_nation, customer.c_city, customer.c_custkey

SELECT * INTO gpusort_result1 FROM (
    SELECT c_region, c_nation, c_city, SUM(lo_revenue) lo_rev,
            RANK() OVER(PARTITION BY c_region, c_nation
                        ORDER BY SUM(lo_revenue)) rank
        FROM lineorder, customer
    WHERE lo_custkey = c_custkey
        AND lo_shipmode IN ('RAIL','SHIP')
        GROUP BY c_region, c_nation, c_city
) subqry
WHERE rank < 4;
ERROR:  type with OID 0 does not exist
(SELECT * FROM gpusort_result1 EXCEPT SELECT * FROM gpusort_answer1);
ERROR:  relation "gpusort_result1" does not exist
LINE 1: (SELECT * FROM gpusort_result1 EXCEPT SELECT * FROM gpusort_...
                       ^
(SELECT * FROM gpusort_answer1 EXCEPT SELECT * FROM gpusort_result1);
ERROR:  relation "gpusort_result1" does not exist
LINE 1: ...ELECT * FROM gpusort_answer1 EXCEPT SELECT * FROM gpusort_re...
                                                             ^
DROP TABLE IF EXISTS gpusort_result2;
NOTICE:  table "gpusort_result2" does not exist, skipping
EXPLAIN(costs off, verbose)
SELECT * INTO gpusort_result2 FROM (
    SELECT c_region, c_nation, c_city, AVG(lo_revenue) lo_rev,
            DENSE_RANK() OVER(PARTITION BY c_region, c_nation
                        ORDER BY AVG(lo_revenue) desc) dense_rank
        FROM lineorder, customer
    WHERE lo_custkey = c_custkey
        AND lo_shipmode IN ('RAIL','SHIP')
        GROUP BY c_region, c_nation, c_city
) subqry
WHERE dense_rank <= 4;
 WindowAgg
   Output: customer.c_region, customer.c_nation, customer.c_city, (pgstrom.favg_numeric((pgstrom.pavg(lineorder.lo_revenue)))), dense_rank() OVER w1
   Window: w1 AS (PARTITION BY customer.c_region, customer.c_nation ORDER BY (pgstrom.favg_numeric((pgstrom.pavg(lineorder.lo_revenue)))) ROWS UNBOUNDED PRECEDING)
   Run Condition: (dense_rank() OVER w1 <= 4)
   ->  Sort
         Output: customer.c_region, customer.c_nation, customer.c_city, (pgstrom.favg_numeric((pgstrom.pavg(lineorder.lo_revenue))))
         Sort Key: customer.c_region, customer.c_nation, (pgstrom.favg_numeric((pgstrom.pavg(lineorder.lo_revenue)))) DESC
         ->  Gather
               Output: customer.c_region, customer.c_nation, customer.c_city, (pgstrom.favg_numeric((pgstrom.pavg(lineorder.lo_revenue))))
               Workers Planned: 2
               ->  Parallel Custom Scan (GpuPreAgg) on public.lineorder
                     Output: customer.c_region, customer.c_nation, customer.c_city, pgstrom.favg_numeric((pgstrom.pavg(lineorder.lo_revenue)))
                     GPU Projection: pgstrom.pavg(lineorder.lo_revenue), customer.c_region, customer.c_nation, customer.c_city
                     GPU Scan Quals: (lineorder.lo_shipmode = ANY ('{RAIL,SHIP}'::bpchar[]))
                     GPU Join Quals [1]: (lineorder.lo_custkey = customer.c_custkey)
                     GPU Outer Hash [1]: lineorder.lo_custkey
                     GPU Inner Hash [1]: customer.c_custkey
                     GPU Group Key: customer.c_region, customer.c_nation, customer.c_city
                     ->  Parallel Seq Scan on public.customer
                           Output: customer.c_region, customer.c_nation, customer.c_city, customer.c_custkey

SELECT * INTO gpusort_result2 FROM (
    SELECT c_region, c_nation, c_city, AVG(lo_revenue) lo_rev,
            DENSE_RANK() OVER(PARTITION BY c_region, c_nation
                        ORDER BY AVG(lo_revenue) desc) dense_rank
        FROM lineorder, customer
    WHERE lo_custkey = c_custkey
        AND lo_shipmode IN ('RAIL','SHIP')
        GROUP BY c_region, c_nation, c_city
) subqry
WHERE dense_rank <= 4;
ERROR:  type with OID 0 does not exist
(SELECT * FROM gpusort_result2 EXCEPT SELECT * FROM gpusort_answer2);
ERROR:  relation "gpusort_result2" does not exist
LINE 1: (SELECT * FROM gpusort_result2 EXCEPT SELECT * FROM gpusort_...
                       ^
(SELECT * FROM gpusort_answer2 EXCEPT SELECT * FROM gpusort_result2);
ERROR:  relation "gpusort_result2" does not exist
LINE 1: ...ELECT * FROM gpusort_answer2 EXCEPT SELECT * FROM gpusort_re...
                                                             ^
DROP TABLE IF EXISTS gpusort_result3;
NOTICE:  table "gpusort_result3" does not exist, skipping
EXPLAIN(costs off, verbose)
SELECT * INTO gpusort_result3 FROM (
    SELECT c_region, c_nation, c_city, MAX(lo_revenue) lo_rev,
            ROW_NUMBER() OVER(PARTITION BY c_region, c_nation
                        ORDER BY MAX(lo_revenue)) row_number
        FROM lineorder, customer
    WHERE lo_custkey = c_custkey
        AND lo_shipmode IN ('RAIL','SHIP')
        GROUP BY c_region, c_nation, c_city
) subqry
WHERE row_number <= 4;
 WindowAgg
   Output: customer.c_region, customer.c_nation, customer.c_city, (pgstrom.fmax_num((pgstrom.pmax((lineorder.lo_revenue)::double precision)))), row_number() OVER w1
   Window: w1 AS (PARTITION BY customer.c_region, customer.c_nation ORDER BY (pgstrom.fmax_num((pgstrom.pmax((lineorder.lo_revenue)::double precision)))) ROWS UNBOUNDED PRECEDING)
   Run Condition: (row_number() OVER w1 <= 4)
   ->  Gather
         Output: customer.c_region, customer.c_nation, customer.c_city, (pgstrom.fmax_num((pgstrom.pmax((lineorder.lo_revenue)::double precision))))
         Workers Planned: 2
         ->  Parallel Custom Scan (GpuPreAgg) on public.lineorder
               Output: customer.c_region, customer.c_nation, customer.c_city, pgstrom.fmax_num((pgstrom.pmax((lineorder.lo_revenue)::double precision)))
               GPU Projection: pgstrom.pmax((lineorder.lo_revenue)::double precision), customer.c_region, customer.c_nation, customer.c_city
               GPU Scan Quals: (lineorder.lo_shipmode = ANY ('{RAIL,SHIP}'::bpchar[]))
               GPU Join Quals [1]: (lineorder.lo_custkey = customer.c_custkey)
               GPU Outer Hash [1]: lineorder.lo_custkey
               GPU Inner Hash [1]: customer.c_custkey
               GPU Group Key: customer.c_region, customer.c_nation, customer.c_city
               GPU-Sort keys: customer.c_region ASC NULLS LAST, customer.c_nation ASC NULLS LAST, pgstrom.fmax_num((pgstrom.pmax((lineorder.lo_revenue)::double precision))) ASC NULLS LAST
               Window-Rank Filter: row_number() over(PARTITION BY customer.c_region, customer.c_nation ORDER BY pgstrom.fmax_num((pgstrom.pmax((lineorder.lo_revenue)::double precision)))) < 5
               ->  Parallel Seq Scan on public.customer
                     Output: customer.c_region, customer.c_nation, customer.c_city, customer.c_custkey

SELECT * INTO gpusort_result3 FROM (
    SELECT c_region, c_nation, c_city, MAX(lo_revenue) lo_rev,
            ROW_NUMBER() OVER(PARTITION BY c_region, c_nation
                        ORDER BY MAX(lo_revenue)) row_number
        FROM lineorder, customer
    WHERE lo_custkey = c_custkey
        AND lo_shipmode IN ('RAIL','SHIP')
        GROUP BY c_region, c_nation, c_city
) subqry
WHERE row_number <= 4;
ERROR:  type with OID 16842751 does not exist
(SELECT * FROM gpusort_result3 EXCEPT SELECT * FROM gpusort_answer3);
ERROR:  relation "gpusort_result3" does not exist
LINE 1: (SELECT * FROM gpusort_result3 EXCEPT SELECT * FROM gpusort_...
                       ^
(SELECT * FROM gpusort_answer3 EXCEPT SELECT * FROM gpusort_result3);
ERROR:  relation "gpusort_result3" does not exist
LINE 1: ...ELECT * FROM gpusort_answer3 EXCEPT SELECT * FROM gpusort_re...
                                                             ^
DROP TABLE gpusort_answer1;
DROP TABLE gpusort_answer2;
DROP TABLE gpusort_answer3;
